<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Oh my dog！ - 个人中心</title>
    <style>
        :root {
            --primary-color: #3d8b7e;
            --secondary-color: #5ba898;
            --accent-color: #7bc5b7;
            --background-color: #edf6f5;
            --card-background: #ffffff;
            --border-color: #d4ede9;
            --text-primary: #2a4f49;
            --text-secondary: #3e6b61;
            --blue-accent: #6fa5c3;
            --blue-light: #a8c8da;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-image: url('/petblog/images/profile.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            color: var(--text-primary);
            line-height: 1.6;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--blue-accent) 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 20px rgba(74, 155, 142, 0.2);
        }

        .nav {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            height: 60px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: white;
            text-decoration: none;
            letter-spacing: 1px;
        }

        .nav-links {
            display: flex;
        }

        .nav-links a {
            margin-left: 24px;
            color: white;
            text-decoration: none;
            font-weight: 500;
            border-radius: 20px;
            padding: 8px 16px;
            transition: background 0.2s, color 0.2s;
        }

        .nav-links a:first-child {
            margin-left: 0;
        }

        .nav-links a:hover, .nav-links a.active {
            background: rgba(255, 255, 255, 0.12);
            color: #fff;
        }

        .main-content {
            max-width: 1200px;
            margin: 40px auto 40px;
            padding: 0 20px;
            min-height: 600px;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .profile-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 30px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 8px 40px rgba(74, 155, 142, 0.15);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }

        .profile-sidebar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--blue-accent) 100%);
            color: white;
            padding: 30px;
        }

        .profile-sidebar h2 {
            margin-bottom: 20px;
            font-size: 24px;
        }

        .profile-menu {
            list-style: none;
        }

        .profile-menu li {
            margin-bottom: 10px;
        }

        .profile-menu a {
            color: white;
            text-decoration: none;
            display: block;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .profile-menu a:hover,
        .profile-menu a.active {
            background: rgba(255, 255, 255, 0.1);
        }

        .profile-content {
            padding: 30px;
        }

        .profile-section {
            display: none;
        }

        .profile-section.active {
            display: block;
        }

        .section-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
        }

        .pets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .pet-card {
            background: var(--card-background);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(74, 155, 142, 0.1);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .pet-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 35px rgba(74, 155, 142, 0.15);
            border-color: var(--accent-color);
        }

        .pet-avatar img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }

        .pet-info {
            padding: 20px;
        }

        .pet-info h3 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .pet-info p {
            color: #666;
            margin-bottom: 5px;
        }

        .add-pet-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: var(--secondary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            text-decoration: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .add-pet-btn:hover {
            transform: scale(1.1);
            background: var(--primary-color);
        }

        .user-avatar-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .user-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--secondary-color);
            box-shadow: 0 5px 20px rgba(74, 155, 142, 0.2);
            transition: transform 0.3s ease;
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        /* 博客内容中的图片样式 */
        .blog-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* 弹窗样式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(74, 155, 142, 0.15);
            backdrop-filter: blur(8px);
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .modal-content {
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            box-shadow: 0 15px 50px rgba(74, 155, 142, 0.2);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            padding: 25px 30px 15px 30px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--primary-color);
            font-size: 20px;
        }

        .modal-body {
            padding: 20px 30px;
        }

        .modal-footer {
            padding: 15px 30px 25px 30px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn-primary {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background: var(--primary-color);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: #f8f9fa;
            color: var(--text-primary);
        }

        /* 博客项目样式 */
        .blog-item {
            background: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .blog-item:hover {
            border-color: var(--secondary-color);
            background: #f0f8f7;
        }

        .blog-item-info {
            flex: 1;
        }

        .blog-item-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .blog-item-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .blog-item-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-add {
            background: var(--secondary-color);
            color: white;
        }

        .btn-add:hover {
            background: var(--primary-color);
        }

        .btn-remove {
            background: #e74c3c;
            color: white;
        }

        .btn-remove:hover {
            background: #c0392b;
        }

        /* 我的喜欢样式 */
        .likes-container {
            margin-top: 20px;
        }

        .like-blog-card {
            background: #fff;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(74, 155, 142, 0.1);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .like-blog-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, #e74c3c, #f39c12);
            border-radius: 2px;
        }

        .like-blog-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 35px rgba(74, 155, 142, 0.15);
            border-color: var(--accent-color);
        }

        .like-blog-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .like-blog-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 12px;
            border: 2px solid #e0e0e0;
        }

        .like-blog-user-info {
            flex: 1;
        }

        .like-blog-user-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 15px;
            margin-bottom: 2px;
        }

        .like-blog-time {
            color: #888;
            font-size: 12px;
        }

        .like-time-badge {
            background: linear-gradient(135deg, #e74c3c, #f39c12);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .like-blog-title {
            font-size: 18px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .like-blog-content {
            color: #555;
            margin-bottom: 12px;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .like-blog-pets {
            margin-bottom: 8px;
        }

        .like-blog-pets-title {
            font-size: 12px;
            color: #888;
            margin-bottom: 4px;
        }

        .like-blog-pet-tag {
            display: inline-flex;
            align-items: center;
            background: #f0f8f7;
            padding: 4px 10px;
            border-radius: 12px;
            margin-right: 6px;
            margin-bottom: 4px;
            font-size: 12px;
            border: 1px solid var(--accent-color);
        }

        .like-blog-pet-tag img {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 4px;
            object-fit: cover;
        }

        .like-blog-column {
            background: #f5eaff;
            color: #8e44ad;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 12px;
            margin-right: 8px;
            display: inline-block;
        }

        .like-blog-topics {
            margin-top: 8px;
        }

        .like-blog-topic {
            background: #eaf6ff;
            color: #3498db;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 12px;
            margin-right: 5px;
            display: inline-block;
            border: 1px solid #b3e0ff;
        }

        .like-blog-stats {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            color: #888;
            font-size: 14px;
        }

        .like-blog-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .like-blog-attachment {
            margin-top: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .like-blog-attachment a {
            color: #3498db;
            text-decoration: none;
            font-size: 12px;
        }

        .like-blog-attachment a:hover {
            text-decoration: underline;
        }

        .likes-empty {
            text-align: center;
            color: #888;
            padding: 60px 20px;
            font-size: 16px;
        }

        .likes-loading {
            text-align: center;
            color: #666;
            padding: 40px 20px;
            font-style: italic;
        }

        .likes-error {
            text-align: center;
            color: #e74c3c;
            padding: 40px 20px;
            font-size: 14px;
        }

        .recommend-follows-card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(74, 155, 142, 0.08);
            border: 1px solid #e0f2ef;
            padding: 18px 16px 12px 16px;
            margin-bottom: 20px;
        }
        .recommend-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #3d8b7e;
            margin-bottom: 12px;
        }
        .recommend-user-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .recommend-user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 1.5px solid #e0f2ef;
        }
        .recommend-user-info {
            flex: 1;
        }
        .recommend-user-name {
            font-weight: 600;
            color: #2a4f49;
            font-size: 15px;
        }
        .recommend-user-stats {
            font-size: 12px;
            color: #888;
        }
        .recommend-follow-btn {
            background: #3d8b7e;
            color: #fff;
            border: none;
            border-radius: 16px;
            padding: 6px 16px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .recommend-follow-btn:hover {
            background: #217dbb;
        }
    </style>
</head>
<body>
    <header>
        <div class="nav">
            <a href="/petblog/index.html" class="logo">Oh my dog！</a>
            <div class="nav-links">
                <a href="/petblog/index.html">首页</a>
                <a href="/petblog/challenges.html">挑战</a>
                <a href="/petblog/profile.html" class="active">个人中心</a>
                <a href="javascript:void(0)" onclick="logout()">退出登录</a>
            </div>
        </div>
    </header>

    <div class="main-content">
        <div class="profile-container">
            <div class="profile-sidebar">
                <h2>个人中心</h2>
                <ul class="profile-menu">
                    <li><a href="#personal-info" class="active">个人信息</a></li>
                    <li><a href="#pet-info">宠物信息</a></li>
                    <li><a href="#my-columns">我的专栏</a></li>
                    <li><a href="#my-favorites">我的收藏</a></li>
                    <li><a href="#my-likes">我的喜欢</a></li>
                    <li><a href="#my-follows">关注管理</a></li>
                </ul>
            </div>

            <div class="profile-content">
                <div id="personal-info" class="profile-section active">
                    <h2 class="section-title">个人信息</h2>
                    <div class="user-avatar-container">
                        <label for="avatar-upload" style="cursor:pointer;display:inline-block;">
                            <img id="user-avatar" src="/petblog/images/Default avatar.png" alt="用户头像" class="user-avatar">
                            <input type="file" id="avatar-upload" accept="image/*" style="display:none">
                        </label>
                        <div id="avatar-upload-tip" style="font-size:13px;color:#888;margin-top:8px;">点击头像更换</div>
                    </div>
                    <form id="personalInfoForm">
                        <div class="form-group">
                            <label for="user_name">用户名</label>
                            <input type="text" id="user_name" name="user_name" required>
                        </div>
                        <div class="form-group">
                            <label for="email">邮箱</label>
                            <input type="email" id="email" name="email" required>
                        </div>
                        <div class="form-group">
                            <label for="new-password">新密码</label>
                            <input type="password" id="new-password" name="new-password" placeholder="输入新密码">
                        </div>
                        <div class="form-group">
                            <label for="confirm-password">确认新密码</label>
                            <input type="password" id="confirm-password" name="confirm-password" placeholder="再次输入新密码">
                        </div>
                        <button type="submit" class="btn">保存修改</button>
                    </form>
                </div>

                <div id="pet-info" class="profile-section">
                    <h2 class="section-title">宠物信息</h2>
                    <button id="addPetBtn" class="btn" style="margin-bottom:20px;">添加宠物</button>
                    <div id="petsList" class="pets-grid">
                        <!-- 宠物信息将通过JavaScript动态加载 -->
                    </div>
                </div>

                <div id="my-columns" class="profile-section">
                    <h2 class="section-title">我的专栏</h2>
                    <button class="btn" id="addColumnBtn" style="margin-bottom:20px;">添加专栏</button>
                    <div id="columnsList"></div>
                </div>

                <div id="my-favorites" class="profile-section">
                    <h2 class="section-title">我的收藏</h2>
                    <div id="favoritesList"></div>
                </div>

                <div id="my-likes" class="profile-section">
                    <h2 class="section-title">我的喜欢</h2>
                    <div id="likesList"></div>
                </div>

                <div id="my-follows" class="profile-section">
                    <h2 class="section-title">关注管理</h2>
                    <div style="margin-bottom:20px;">
                        <button class="btn" onclick="showFollowing()">我的关注</button>
                    </div>
                    <div id="followsList"></div>
                    <!-- 推荐关注区域 -->
                    <div class="recommend-follows-card">
                        <div class="recommend-title">推荐关注</div>
                        <div id="recommendFollowsList">
                            <div style="color:#888;text-align:center;padding:10px;">正在加载...</div>
                        </div>
                    </div>
                </div>


            </div>
        </div>
    </div>

    <a href="/add-pet" class="add-pet-btn">+</a>

    <!-- 所有弹窗移到这里，避免被父容器裁剪 -->

    <!-- 添加宠物弹窗 -->
    <div id="addPetModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加宠物</h3>
                <button type="button" class="close-btn" onclick="closeAddPetModal()">&times;</button>
            </div>
            <form id="addPetForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label>宠物昵称</label>
                        <input type="text" name="pet_name" required>
                    </div>
                    <div class="form-group">
                        <label>性别</label>
                        <select name="pet_gender" required>
                            <option value="公">公</option>
                            <option value="母">母</option>
                            <option value="未知">未知</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>品种</label>
                        <input type="text" name="pet_breed" required>
                    </div>
                    <div class="form-group">
                        <label>出生日期</label>
                        <input type="date" name="pet_birthdate" required>
                    </div>
                    <div class="form-group">
                        <label>宠物头像</label>
                        <input type="file" name="pet_avatar" accept="image/*">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeAddPetModal()">取消</button>
                    <button type="submit" class="btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 添加/编辑专栏弹窗 -->
    <div id="columnModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="columnModalTitle">添加专栏</h3>
                <button type="button" class="close-btn" onclick="closeColumnModal()">&times;</button>
            </div>
            <form id="columnForm">
                <div class="modal-body">
                    <input type="hidden" name="column_id" id="column_id">
                    <div class="form-group">
                        <label>专栏名称</label>
                        <input type="text" name="column_name" id="column_name" required>
                    </div>
                    <div class="form-group">
                        <label>专栏描述</label>
                        <input type="text" name="column_description" id="column_description">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeColumnModal()">取消</button>
                    <button type="submit" class="btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 编辑宠物弹窗 -->
    <div id="editPetModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>编辑宠物</h3>
                <button type="button" class="close-btn" onclick="closeEditPetModal()">&times;</button>
            </div>
            <form id="editPetForm">
                <div class="modal-body">
                    <input type="hidden" name="pet_id">
                    <div class="form-group">
                        <label>宠物昵称</label>
                        <input type="text" name="pet_name" required>
                    </div>
                    <div class="form-group">
                        <label>性别</label>
                        <select name="pet_gender" required>
                            <option value="公">公</option>
                            <option value="母">母</option>
                            <option value="未知">未知</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>品种</label>
                        <input type="text" name="pet_breed" required>
                    </div>
                    <div class="form-group">
                        <label>出生日期</label>
                        <input type="date" name="pet_birthdate" required>
                    </div>
                    <div class="form-group">
                        <label>宠物头像</label>
                        <input type="file" name="pet_avatar" accept="image/*">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeEditPetModal()">取消</button>
                    <button type="submit" class="btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 专栏博客管理弹窗 -->
    <div id="columnBlogsModal" class="modal-overlay" style="display:none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="columnBlogsTitle">专栏博客管理</h3>
                <button type="button" class="close-btn" onclick="closeColumnBlogsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- 专栏中的博客 -->
                <div style="margin-bottom: 30px;">
                    <h4 style="margin-bottom: 15px; color: var(--primary-color);">专栏中的博客</h4>
                    <div id="columnBlogsList" style="max-height: 300px; overflow-y: auto;">
                        <!-- 专栏博客列表 -->
                    </div>
                </div>

                <!-- 我的其他博客 -->
                <div>
                    <h4 style="margin-bottom: 15px; color: var(--primary-color);">我的其他博客</h4>
                    <div id="otherBlogsList" style="max-height: 300px; overflow-y: auto;">
                        <!-- 其他博客列表 -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeColumnBlogsModal()">关闭</button>
            </div>
        </div>
    </div>

    <script>
        // 处理博客内容中的图片
        function processImageContent(content) {
            // 处理Markdown风格的图片语法 ![alt](url)
            const markdownImageRegex = /!\[([^\]]*)\]\(([^)]+)\)/g;
            content = content.replace(markdownImageRegex, '<img src="$2" alt="$1" loading="lazy">');

            // 处理HTML img标签（如果已经是img标签就不处理）
            if (content.includes('<img')) {
                return content;
            }

            // 处理图片URL，将其转换为img标签
            const imageRegex = /(https?:\/\/[^\s<>"]+\.(jpg|jpeg|png|gif|webp|bmp|svg))/gi;
            content = content.replace(imageRegex, '<img src="$1" alt="博客图片" loading="lazy">');

            // 处理本地图片路径
            const localImageRegex = /(\/images\/[^\s<>"]+\.(jpg|jpeg|png|gif|webp|bmp|svg))/gi;
            content = content.replace(localImageRegex, '<img src="$1" alt="博客图片" loading="lazy">');

            return content;
        }

        // 切换个人中心和宠物信息标签
        document.querySelectorAll('.profile-menu a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);
                
                // 更新活动标签
                document.querySelectorAll('.profile-menu a').forEach(a => a.classList.remove('active'));
                link.classList.add('active');
                
                // 显示对应内容
                document.querySelectorAll('.profile-section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(targetId).classList.add('active');
            });
        });

        // 获取用户信息
        async function fetchUserInfo() {
            try {
                // 从 sessionStorage 获取当前用户ID
                const currentUserStr = sessionStorage.getItem('currentUser');
                let userId = null;
                
                if (currentUserStr) {
                    try {
                        const currentUser = JSON.parse(currentUserStr);
                        userId = currentUser.userId;
                    } catch (e) {
                        console.error('解析用户信息失败:', e);
                    }
                }
                
                if (!userId) {
                    console.error('无法获取当前用户ID');
                    return;
                }
                
                const response = await fetch(`/petblog/api/user/profile?userId=${userId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const userData = await response.json();
                
                // 填充表单
                document.getElementById('user_name').value = userData.userName || '';
                document.getElementById('email').value = userData.email || '';

                // 显示用户头像
                const userAvatar = document.getElementById('user-avatar');
                if (userData.userAvatarPath) {
                    // 移除 'public/' 前缀并将反斜杠转换为正斜杠
                    const avatarUrl = userData.userAvatarPath.replace(/\\/g, '/').replace('public/', '/');
                    // 确保路径以 /petblog 开头
                    userAvatar.src = avatarUrl.startsWith('/petblog') ? avatarUrl : `/petblog${avatarUrl}`;
                } else {
                    userAvatar.src = '/petblog/images/Default avatar.png'; // 默认头像
                }
            } catch (error) {
                console.error('获取用户信息失败:', error);
            }
        }

        // 获取宠物列表
        function fetchPets() {
            fetch('/petblog/api/pets/my')
                .then(response => response.json())
                .then(pets => {
                    window.currentPets = pets; // 关键：全局保存
                    const petsList = document.getElementById('petsList');
                    petsList.innerHTML = '';
                    
                    if (pets.length === 0) {
                        petsList.innerHTML = '<p>暂无宠物信息</p>';
                        return;
                    }

                    pets.forEach(pet => {
                        const petCard = document.createElement('div');
                        petCard.className = 'pet-card';
                        const petId = pet.pet_id;
                        // 使用 pet_avatar_path 属性显示宠物头像
                        const imageUrl = pet.pet_avatar_path ? pet.pet_avatar_path.replace(/\\/g, '/').replace('public/', '/') : '/images/pet-avatar.png';
                        petCard.innerHTML = `
                            <div class="pet-avatar">
                                <img src="${imageUrl}" alt="${pet.pet_name}的头像">
                            </div>
                            <div class="pet-info">
                                <h3>${pet.pet_name}</h3>
                                <p>品种：${pet.pet_breed}</p>
                                <p>性别：${pet.pet_gender}</p>
                                <p>出生日期：${new Date(pet.pet_birthdate).toLocaleDateString()}</p>
                                <div style="margin-top:10px;">
                                    <button class="btn" onclick="window.editPet(${petId})" style="margin-right:8px;">编辑</button>
                                    <button class="btn" style="background:#e74c3c;" onclick="window.deletePet(${petId})">删除</button>
                                </div>
                            </div>
                        `;
                        petsList.appendChild(petCard);
                    });
                })
                .catch(error => {
                    console.error('获取宠物列表失败:', error);
                    document.getElementById('petsList').innerHTML = '<p>获取宠物信息失败</p>';
                });
        }

        // 处理个人信息表单提交
        document.getElementById('personalInfoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const user_name = document.getElementById('user_name').value;
            const email = document.getElementById('email').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (newPassword && newPassword !== confirmPassword) {
                alert('两次输入的密码不一致');
                return;
            }

            if (newPassword && newPassword.length < 6) {
                alert('密码长度不能少于6位');
                return;
            }

            const formData = {
                user_name: user_name,
                email: email,
                newPassword: newPassword
            };

            try {
                const response = await fetch('/petblog/api/user/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                if (result.success) {
                    alert('个人信息更新成功！');
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';
                } else {
                    alert(result.message || '更新失败，请重试');
                }
            } catch (error) {
                console.error('更新个人信息失败:', error);
                alert('更新失败，请重试');
            }
        });

        // 页面加载时获取数据
        document.addEventListener('DOMContentLoaded', () => {
            fetchUserInfo();
            fetchPets();
        });

        // 头像上传逻辑
        document.getElementById('avatar-upload').addEventListener('change', async function() {
            const file = this.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('avatar', file);
            try {
                const res = await fetch('/petblog/api/user/avatar', {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                if (result.success) {
                    document.getElementById('user-avatar').src = result.avatarUrl + '?t=' + Date.now(); // 防止缓存
                    alert('头像修改成功！');
                } else {
                    alert(result.message || '头像上传失败');
                }
            } catch (e) {
                alert('头像上传失败');
            }
        });

        // 弹窗控制函数
        function showAddPetModal() {
            document.getElementById('addPetModal').style.display = 'flex';
        }

        function closeAddPetModal() {
            document.getElementById('addPetModal').style.display = 'none';
        }

        function showColumnModal() {
            document.getElementById('columnModal').style.display = 'flex';
        }

        function closeColumnModal() {
            document.getElementById('columnModal').style.display = 'none';
        }

        function showEditPetModal() {
            document.getElementById('editPetModal').style.display = 'flex';
        }

        function closeEditPetModal() {
            document.getElementById('editPetModal').style.display = 'none';
        }

        function showColumnBlogsModal() {
            document.getElementById('columnBlogsModal').style.display = 'flex';
        }

        function closeColumnBlogsModal() {
            document.getElementById('columnBlogsModal').style.display = 'none';
        }

        // 添加宠物弹窗逻辑
        document.getElementById('addPetBtn').onclick = showAddPetModal;

        // 点击背景关闭弹窗
        document.getElementById('addPetModal').onclick = function(e) {
            if (e.target === this) closeAddPetModal();
        };
        document.getElementById('columnModal').onclick = function(e) {
            if (e.target === this) closeColumnModal();
        };
        document.getElementById('editPetModal').onclick = function(e) {
            if (e.target === this) closeEditPetModal();
        };
        document.getElementById('columnBlogsModal').onclick = function(e) {
            if (e.target === this) closeColumnBlogsModal();
        };
        document.getElementById('addPetForm').onsubmit = async function(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            try {
                const res = await fetch('/petblog/api/user/pets/add', {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                if (result.success) {
                    alert('添加成功！');
                    closeAddPetModal();
                    fetchPets();
                } else {
                    alert(result.message || '添加失败');
                }
            } catch (err) {
                alert('添加失败');
            }
        };

        // 编辑宠物弹窗
        let editingPetId = null;
        window.editPet = function(petId) {
            const pet = window.currentPets.find(p => String(p.pet_id) === String(petId));
            if (!pet) return;
            editingPetId = petId;
            const form = document.getElementById('editPetForm');
            form.pet_id.value = pet.pet_id;
            form.pet_name.value = pet.pet_name;
            form.pet_gender.value = pet.pet_gender;
            form.pet_breed.value = pet.pet_breed;
            form.pet_birthdate.value = pet.pet_birthdate ? pet.pet_birthdate.substr(0,10) : '';
            showEditPetModal();
        };
        document.getElementById('editPetForm').onsubmit = async function(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            // 确保pet_id字段正确
            if (!formData.get('pet_id')) {
                formData.set('pet_id', editingPetId);
            }
            try {
                const res = await fetch('/petblog/api/user/pets/update', {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                if (result.success) {
                    alert('修改成功！');
                    closeEditPetModal();
                    fetchPets();
                } else {
                    alert(result.message || '修改失败');
                }
            } catch (err) {
                alert('修改失败');
            }
        };
        // 删除宠物
        window.deletePet = function(petId) {
            if (!confirm('确定要删除该宠物吗？删除后与该宠物关联的所有博客及相关数据也会被一并删除，且无法恢复！')) return;
            fetch('/petblog/api/user/pets/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pet_id: petId })
            })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    alert('删除成功！');
                    fetchPets();
                } else {
                    alert(result.message || '删除失败');
                }
            })
            .catch(() => alert('删除失败'));
        };

        // 专栏tab切换
        document.querySelector('a[href="#my-columns"]').addEventListener('click', function() {
            loadMyColumns();
        });

        // 收藏tab切换
        document.querySelector('a[href="#my-favorites"]').addEventListener('click', function() {
            loadMyFavorites();
        });

        // 我的喜欢tab切换
        document.querySelector('a[href="#my-likes"]').addEventListener('click', function() {
            loadMyLikes();
        });

        // 关注管理tab切换
        document.querySelector('a[href="#my-follows"]').addEventListener('click', function() {
            // 默认显示关注列表
            showFollowing();
        });

        // 加载专栏列表
        async function loadMyColumns() {
            const res = await fetch('/petblog/api/my-columns');
            const columns = await res.json();
            const list = document.getElementById('columnsList');
            if (!columns.length) {
                list.innerHTML = '<p>暂无专栏</p>';
                return;
            }
            list.innerHTML = columns.map(col => `
                <div class="column-card" style="background:#fff;padding:18px 20px;margin-bottom:12px;border-radius:10px;box-shadow:0 2px 8px rgba(44,62,80,0.06);">
                    <div style="font-size:18px;font-weight:bold;">${col.Column_name}</div>
                    <div style="color:#888;margin:6px 0 8px 0;">${col.Column_description||''}</div>
                    <div style="font-size:13px;color:#aaa;">创建时间：${new Date(col.Column_createdtime).toLocaleString()}</div>
                    <div style="margin-top:10px;">
                        <button class="btn" onclick="showColumnBlogs(${col.Column_id}, '${col.Column_name.replace(/'/g,"\\'")}')">管理博客</button>
                        <button class="btn" onclick="editColumn(${col.Column_id},'${col.Column_name.replace(/'/g,"\\'")}', '${(col.Column_description||'').replace(/'/g,"\\'")}')">编辑</button>
                        <button class="btn" style="background:#e74c3c;" onclick="deleteColumn(${col.Column_id})">删除</button>
                    </div>
                </div>
            `).join('');
        }

        // 打开添加专栏弹窗
        document.getElementById('addColumnBtn').onclick = function() {
            document.getElementById('columnModalTitle').innerText = '添加专栏';
            document.getElementById('column_id').value = '';
            document.getElementById('column_name').value = '';
            document.getElementById('column_description').value = '';
            showColumnModal();
        };

        // 编辑专栏
        window.editColumn = function(id, name, desc) {
            document.getElementById('columnModalTitle').innerText = '编辑专栏';
            document.getElementById('column_id').value = id;
            document.getElementById('column_name').value = name;
            document.getElementById('column_description').value = desc;
            showColumnModal();
        };

        // 删除专栏
        window.deleteColumn = async function(id) {
            if (!confirm('确定要删除该专栏吗？')) return;
            const res = await fetch('/petblog/api/column/delete', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ column_id: id })
            });
            const result = await res.json();
            if (result.success) {
                alert('删除成功');
                loadMyColumns();
            } else {
                alert(result.message || '删除失败');
            }
        };

        // 提交添加/编辑专栏
        document.getElementById('columnForm').onsubmit = async function(e) {
            e.preventDefault();
            const id = document.getElementById('column_id').value;
            const name = document.getElementById('column_name').value.trim();
            const desc = document.getElementById('column_description').value.trim();
            const url = id ? '/api/column/update' : '/api/column/add';
            const res = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ column_id: id, column_name: name, column_description: desc })
            });
            const result = await res.json();
            if (result.success) {
                alert(id ? '修改成功' : '添加成功');
                closeColumnModal();
                loadMyColumns();
            } else {
                alert(result.message || (id ? '修改失败' : '添加失败'));
            }
        };

        // 显示专栏博客管理
        let currentColumnId = null;
        async function showColumnBlogs(columnId, columnName) {
            currentColumnId = columnId;
            document.getElementById('columnBlogsTitle').textContent = `管理专栏：${columnName}`;

            // 加载专栏中的博客和其他博客
            await loadColumnBlogs(columnId);
            await loadOtherBlogs(columnId);

            showColumnBlogsModal();
        }

        // 加载专栏中的博客
        async function loadColumnBlogs(columnId) {
            try {
                const response = await fetch(`/api/columns/${columnId}/blogs`);
                const blogs = await response.json();

                const container = document.getElementById('columnBlogsList');
                if (blogs.length === 0) {
                    container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">该专栏暂无博客</p>';
                    return;
                }

                container.innerHTML = blogs.map(blog => `
                    <div class="blog-item">
                        <div class="blog-item-info">
                            <div class="blog-item-title">${blog.blog_title}</div>
                            <div class="blog-item-meta">发布时间：${new Date(blog.blog_create_time).toLocaleString()}</div>
                        </div>
                        <div class="blog-item-actions">
                            <button class="btn-small btn-remove" onclick="removeBlogFromColumn(${blog.blog_id})">移出专栏</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('加载专栏博客失败:', error);
                document.getElementById('columnBlogsList').innerHTML = '<p style="color: #e74c3c; text-align: center; padding: 20px;">加载失败</p>';
            }
        }

        // 加载其他博客（不在当前专栏中的）
        async function loadOtherBlogs(columnId) {
            try {
                const response = await fetch(`/api/blogs/my/not-in-column/${columnId}`);
                const blogs = await response.json();

                const container = document.getElementById('otherBlogsList');
                if (blogs.length === 0) {
                    container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">没有其他可添加的博客</p>';
                    return;
                }

                container.innerHTML = blogs.map(blog => `
                    <div class="blog-item">
                        <div class="blog-item-info">
                            <div class="blog-item-title">${blog.blog_title}</div>
                            <div class="blog-item-meta">发布时间：${new Date(blog.blog_create_time).toLocaleString()}</div>
                        </div>
                        <div class="blog-item-actions">
                            <button class="btn-small btn-add" onclick="addBlogToColumn(${blog.blog_id})">添加到专栏</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('加载其他博客失败:', error);
                document.getElementById('otherBlogsList').innerHTML = '<p style="color: #e74c3c; text-align: center; padding: 20px;">加载失败</p>';
            }
        }

        // 将博客添加到专栏
        async function addBlogToColumn(blogId) {
            try {
                const response = await fetch('/petblog/api/columns/add-blog', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        column_id: currentColumnId,
                        blog_id: blogId
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert('博客已添加到专栏');
                    // 刷新两个列表
                    await loadColumnBlogs(currentColumnId);
                    await loadOtherBlogs(currentColumnId);
                } else {
                    alert(result.message || '添加失败');
                }
            } catch (error) {
                console.error('添加博客到专栏失败:', error);
                alert('网络错误，请重试');
            }
        }

        // 将博客从专栏中移出
        async function removeBlogFromColumn(blogId) {
            if (!confirm('确定要将此博客从专栏中移出吗？')) return;

            try {
                const response = await fetch('/petblog/api/columns/remove-blog', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        column_id: currentColumnId,
                        blog_id: blogId
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert('博客已从专栏中移出');
                    // 刷新两个列表
                    await loadColumnBlogs(currentColumnId);
                    await loadOtherBlogs(currentColumnId);
                } else {
                    alert(result.message || '移出失败');
                }
            } catch (error) {
                console.error('移出博客失败:', error);
                alert('网络错误，请重试');
            }
        }

        // 加载收藏列表
        async function loadMyFavorites() {
            try {
                const res = await fetch('/petblog/api/favorites/my');
                const favorites = await res.json();
                const list = document.getElementById('favoritesList');
                
                if (!favorites.length) {
                    list.innerHTML = '<p>暂无收藏</p>';
                    return;
                }
                
                list.innerHTML = favorites.map(blog => `
                    <div class="favorite-card" style="background:#fff;padding:18px 20px;margin-bottom:12px;border-radius:10px;box-shadow:0 2px 8px rgba(44,62,80,0.06);">
                        <div style="display:flex;align-items:center;margin-bottom:8px;">
                            <img src="${blog.user_avatar_path || '/images/Default avatar.png'}" alt="头像" style="width:32px;height:32px;border-radius:50%;margin-right:10px;">
                            <span style="font-weight:bold;">${blog.user_name}</span>
                            <span style="color:#888;margin-left:10px;font-size:12px;">${new Date(blog.blog_create_time).toLocaleString()}</span>
                        </div>
                        <div style="font-size:16px;font-weight:bold;color:#3498db;margin-bottom:6px;">${blog.blog_title}</div>
                        <div style="color:#333;margin-bottom:8px;white-space:pre-line;">${processImageContent(blog.blog_content.substring(0, 100))}${blog.blog_content.length > 100 ? '...' : ''}</div>
                        ${blog.column_name ? `<span style="background:#f5eaff;color:#8e44ad;border-radius:12px;padding:2px 10px;font-size:12px;margin-right:8px;">${blog.column_name}</span>` : ''}
                        <div style="font-size:12px;color:#aaa;margin-top:8px;">收藏时间：${new Date(blog.favorite_time).toLocaleString()}</div>
                        <div style="margin-top:10px;">
                            <button class="btn" onclick="removeFavorite(${blog.blog_id})" style="background:#e74c3c;">取消收藏</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('加载收藏列表失败:', error);
                document.getElementById('favoritesList').innerHTML = '<p>加载收藏列表失败</p>';
            }
        }

        // 取消收藏
        async function removeFavorite(blogId) {
            if (!confirm('确定要取消收藏该博客吗？')) return;
            
            try {
                const res = await fetch('/petblog/api/favorites/toggle', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ blog_id: blogId })
                });
                const result = await res.json();
                if (result.success) {
                    alert('取消收藏成功');
                    loadMyFavorites();
                } else {
                    alert(result.message || '取消收藏失败');
                }
            } catch (error) {
                console.error('取消收藏失败:', error);
                alert('网络错误，请重试');
            }
        }

        // 显示关注列表
        async function showFollowing() {
            try {
                // 异步获取用户ID
                const userId = await getCurrentUserId();
                console.log('获取关注列表，当前用户ID:', userId);
                
                if (!userId) {
                    document.getElementById('followsList').innerHTML = '<p>无法获取用户信息，请确保已登录</p>';
                    return;
                }
                
                // 显示加载中提示
                document.getElementById('followsList').innerHTML = '<p>加载中...</p>';
                
                const res = await fetch('/petblog/api/follows/following/' + userId);
                if (!res.ok) {
                    throw new Error(`服务器返回错误: ${res.status}`);
                }
                
                const following = await res.json();
                console.log('获取到的关注列表数据:', following);
                
                const list = document.getElementById('followsList');
                
                if (!following || !following.length) {
                    list.innerHTML = '<p>暂无关注</p>';
                    return;
                }
                
                list.innerHTML = `
                    <h3 style="margin-bottom:15px;color:#2c3e50;">我的关注 (${following.length})</h3>
                    <div class="follows-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:15px;">
                        ${following.map(user => `
                            <div class="follow-card" style="background:#fff;padding:15px;border-radius:10px;box-shadow:0 2px 8px rgba(44,62,80,0.06);display:flex;flex-direction:column;align-items:center;text-align:center;">
                                <img src="${user.user_avatar_path || '/images/Default avatar.png'}" alt="头像" style="width:80px;height:80px;border-radius:50%;margin-bottom:10px;object-fit:cover;">
                                <div style="font-weight:bold;color:#2c3e50;margin-bottom:5px;">${user.user_name}</div>
                                <button class="btn" onclick="unfollowUser(${user.user_id})" style="background:#e74c3c;margin-top:10px;width:100%;">取消关注</button>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('加载关注列表失败:', error);
                document.getElementById('followsList').innerHTML = '<p>加载关注列表失败: ' + error.message + '</p>';
            }
        }

        // 显示粉丝列表
        async function showFollowers() {
            try {
                // 异步获取用户ID
                const userId = await getCurrentUserId();
                console.log('获取粉丝列表，当前用户ID:', userId);
                
                if (!userId) {
                    document.getElementById('followsList').innerHTML = '<p>无法获取用户信息，请确保已登录</p>';
                    return;
                }
                
                // 显示加载中提示
                document.getElementById('followsList').innerHTML = '<p>加载中...</p>';
                
                const res = await fetch('/petblog/api/follows/followers/' + userId);
                if (!res.ok) {
                    throw new Error(`服务器返回错误: ${res.status}`);
                }
                
                const followers = await res.json();
                console.log('获取到的粉丝列表数据:', followers);
                
                const list = document.getElementById('followsList');
                
                if (!followers || !followers.length) {
                    list.innerHTML = '<p>暂无粉丝</p>';
                    return;
                }
                
                list.innerHTML = `
                    <h3 style="margin-bottom:15px;color:#2c3e50;">我的粉丝 (${followers.length})</h3>
                    <div class="follows-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:15px;">
                        ${followers.map(user => `
                            <div class="follow-card" style="background:#fff;padding:15px;border-radius:10px;box-shadow:0 2px 8px rgba(44,62,80,0.06);display:flex;flex-direction:column;align-items:center;text-align:center;">
                                <img src="${user.user_avatar_path || '/images/Default avatar.png'}" alt="头像" style="width:80px;height:80px;border-radius:50%;margin-bottom:10px;object-fit:cover;">
                                <div style="font-weight:bold;color:#2c3e50;margin-bottom:5px;">${user.user_name}</div>
                                <button class="btn" onclick="followUser(${user.user_id}, this)" style="background:${user.is_following ? '#27ae60' : '#3498db'};margin-top:10px;width:100%;">
                                    ${user.is_following ? '已关注' : '关注'}
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('加载粉丝列表失败:', error);
                document.getElementById('followsList').innerHTML = '<p>加载粉丝列表失败: ' + error.message + '</p>';
            }
        }

        // 添加关注用户功能
        async function followUser(userId, btn) {
            if (btn) {
                btn.disabled = true;
                btn.textContent = '关注中...';
            }
            try {
                const res = await fetch('/petblog/api/follows/toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ followee_id: userId })
                });
                const result = await res.json();
                if (result.success && result.followed) {
                    if (btn) {
                        btn.textContent = '已关注';
                        btn.classList.add('followed');
                        btn.style.background = '#27ae60';
                        btn.disabled = false;
                    }
                    // 刷新相关区块
                    if (typeof showFollowers === 'function') showFollowers();
                    if (typeof showFollowing === 'function') showFollowing();
                    if (typeof loadRecommendFollows === 'function') loadRecommendFollows();
                } else if (result.success) {
                    if (btn) {
                        btn.textContent = '关注';
                        btn.classList.remove('followed');
                        btn.style.background = '#3498db';
                        btn.disabled = false;
                    }
                    if (typeof showFollowers === 'function') showFollowers();
                    if (typeof showFollowing === 'function') showFollowing();
                    if (typeof loadRecommendFollows === 'function') loadRecommendFollows();
                } else {
                    if (btn) {
                        btn.textContent = '关注';
                        btn.disabled = false;
                    }
                    alert(result.message || '关注失败');
                }
            } catch (e) {
                if (btn) {
                    btn.textContent = '关注';
                    btn.disabled = false;
                }
                alert('网络错误');
            }
        }

        // 取消关注用户
        async function unfollowUser(followeeId) {
            try {
                if (!confirm('确定要取消关注此用户吗？')) {
                    return;
                }
                
                const response = await fetch('/api/follows/toggle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ followee_id: followeeId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('取消关注成功');
                    // 刷新关注列表
                    showFollowing();
                } else {
                    alert(result.message || '操作失败');
                }
            } catch (error) {
                console.error('取消关注失败:', error);
                alert('网络错误，请重试');
            }
        }

        // 获取当前用户ID的辅助函数
        async function getCurrentUserId() {
            try {
                // 从服务器获取当前登录用户信息
                const response = await fetch('/petblog/api/user/profile');
                if (!response.ok) {
                    console.error('获取用户信息失败:', response.status);
                    return null;
                }
                
                const userData = await response.json();
                console.log('获取到的用户信息:', userData);
                
                if (userData && userData.user_id) {
                    return userData.user_id;
                } else {
                    console.error('用户信息中没有user_id字段');
                    return null;
                }
            } catch (error) {
                console.error('获取当前用户ID出错:', error);
                return null;
            }
        }

        // 在页面加载时修改关注管理部分
        document.addEventListener('DOMContentLoaded', function() {
            const followsSection = document.getElementById('my-follows');
            if (followsSection) {
                // 移除原有的按钮容器
                const buttonContainer = followsSection.querySelector('div');
                if (buttonContainer) {
                    buttonContainer.remove();
                }
                
                // 添加切换标签
                const tabsHtml = `
                    <div class="tabs" style="display:flex;margin-bottom:20px;border-bottom:1px solid #eee;">
                        <div id="followingTab" class="tab active" style="padding:10px 20px;cursor:pointer;margin-right:10px;position:relative;" onclick="switchTab('following')">
                            我的关注
                            <div class="tab-indicator" style="position:absolute;bottom:0;left:0;width:100%;height:3px;background:#3498db;display:block;"></div>
                        </div>
                        <div id="followersTab" class="tab" style="padding:10px 20px;cursor:pointer;position:relative;" onclick="switchTab('followers')">
                            我的粉丝
                            <div class="tab-indicator" style="position:absolute;bottom:0;left:0;width:100%;height:3px;background:#3498db;display:none;"></div>
                        </div>
                    </div>
                `;
                
                // 在followsSection的开头插入标签
                const sectionTitle = followsSection.querySelector('.section-title');
                if (sectionTitle) {
                    const tabsContainer = document.createElement('div');
                    tabsContainer.innerHTML = tabsHtml;
                    followsSection.insertBefore(tabsContainer, sectionTitle.nextSibling);
                }
            }
        });

        // 切换标签函数
        function switchTab(tab) {
            if (tab === 'following') {
                document.getElementById('followingTab').classList.add('active');
                document.getElementById('followersTab').classList.remove('active');
                document.getElementById('followingTab').querySelector('.tab-indicator').style.display = 'block';
                document.getElementById('followersTab').querySelector('.tab-indicator').style.display = 'none';
                showFollowing();
            } else {
                document.getElementById('followersTab').classList.add('active');
                document.getElementById('followingTab').classList.remove('active');
                document.getElementById('followersTab').querySelector('.tab-indicator').style.display = 'block';
                document.getElementById('followingTab').querySelector('.tab-indicator').style.display = 'none';
                showFollowers();
            }
        }

        // 加载我的喜欢（点赞的博客）
        async function loadMyLikes() {
            try {
                const response = await fetch('/petblog/api/likes/my');
                if (!response.ok) {
                    throw new Error(`服务器返回错误: ${response.status}`);
                }
                
                const likes = await response.json();
                const likesList = document.getElementById('likesList');
                
                if (!likes || likes.length === 0) {
                    likesList.innerHTML = '<p>暂无点赞</p>';
                    return;
                }
                
                likesList.innerHTML = likes.map(blog => {
                    // 处理附件显示
                    let attachmentHtml = '';
                    if (blog.attachments && blog.attachments.length > 0) {
                        attachmentHtml = '<div style="margin-top:8px;">';
                        blog.attachments.forEach(file => {
                            attachmentHtml += `<a href="${file.file_path}" target="_blank" style="color:#3498db;text-decoration:none;margin-right:10px;">📎 ${file.file_name}</a>`;
                        });
                        attachmentHtml += '</div>';
                    }
                    
                    return `
                        <div class="favorite-card" style="background:#fff;padding:18px 20px;margin-bottom:12px;border-radius:10px;box-shadow:0 2px 8px rgba(44,62,80,0.06);">
                            <div style="display:flex;align-items:center;margin-bottom:8px;">
                                <img src="${blog.user_avatar_path || '/images/Default avatar.png'}" alt="头像" style="width:32px;height:32px;border-radius:50%;margin-right:10px;">
                                <span style="font-weight:bold;">${blog.user_name}</span>
                                <span style="color:#888;margin-left:10px;font-size:12px;">${new Date(blog.blog_create_time).toLocaleString()}</span>
                            </div>
                            <div style="font-size:16px;font-weight:bold;color:#3498db;margin-bottom:6px;">${blog.blog_title}</div>
                            <div style="color:#333;margin-bottom:8px;white-space:pre-line;">${processImageContent(blog.blog_content.substring(0, 100))}${blog.blog_content.length > 100 ? '...' : ''}</div>
                            ${blog.pets && blog.pets.length > 0 ? `
                                <div style="margin-bottom:8px;">
                                    <span style="font-size:12px;color:#888;">提到的狗狗：</span>
                                    ${blog.pets.map(pet => `
                                        <span style="display:inline-flex;align-items:center;background:#f0f8f7;padding:2px 8px;border-radius:10px;margin-right:5px;font-size:12px;">
                                            <img src="${pet.pet_avatar_path || '/images/default-pet.png'}" alt="${pet.pet_name}" style="width:16px;height:16px;border-radius:50%;margin-right:4px;object-fit:cover;">
                                            ${pet.pet_name}
                                        </span>
                                    `).join('')}
                                </div>
                            ` : ''}
                            ${attachmentHtml}
                            ${blog.column_name ? `<span style="background:#f5eaff;color:#8e44ad;border-radius:12px;padding:2px 10px;font-size:12px;margin-right:8px;">${blog.column_name}</span>` : ''}
                            ${blog.topics && blog.topics.length > 0 ? `
                                <div style="margin-top:8px;">
                                    ${blog.topics.map(topic => `<span style="background:#eaf6ff;color:#3498db;border-radius:12px;padding:2px 10px;font-size:12px;margin-right:5px;">#${topic}</span>`).join('')}
                                </div>
                            ` : ''}
                            <div style="font-size:12px;color:#aaa;margin-top:8px;">点赞时间：${new Date(blog.like_time).toLocaleString()}</div>
                            <div style="margin-top:10px;">
                                <button class="btn" onclick="removeLike(${blog.blog_id})" style="background:#e74c3c;">取消点赞</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('加载我的喜欢失败:', error);
                document.getElementById('likesList').innerHTML = '<p>加载我的喜欢失败</p>';
            }
        }

        // 取消点赞
        async function removeLike(blogId) {
            if (!confirm('确定要取消点赞该博客吗？')) return;
            
            try {
                const res = await fetch('/petblog/api/likes/toggle', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ blog_id: blogId })
                });
                const result = await res.json();
                if (result.success) {
                    alert('取消点赞成功');
                    loadMyLikes();
                } else {
                    alert(result.message || '取消点赞失败');
                }
            } catch (error) {
                console.error('取消点赞失败:', error);
                alert('网络错误，请重试');
            }
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 加载我的喜欢
            loadMyLikes();
            
            // 其他初始化代码...
        });

        // 加载推荐关注用户（排除is_ban=1）
        async function loadRecommendFollows() {
            const container = document.getElementById('recommendFollowsList');
            container.innerHTML = '<div style="color:#888;text-align:center;padding:10px;">正在加载...</div>';
            try {
                const res = await fetch('/petblog/api/follows/recommendations');
                let users = await res.json();
                // 兼容API返回格式
                if (users.success && Array.isArray(users.recommendations)) {
                    users = users.recommendations;
                }
                // 排除被封禁用户
                users = users.filter(user => !user.is_ban || user.is_ban === 0);
                if (!Array.isArray(users) || users.length === 0) {
                    container.innerHTML = '<div style="color:#888;text-align:center;padding:10px;">暂无推荐</div>';
                    return;
                }
                container.innerHTML = users.map(user => `
                    <div class="recommend-user-item">
                        <img class="recommend-user-avatar" src="${user.user_avatar_path || '/images/Default avatar.png'}" alt="头像">
                        <div class="recommend-user-info">
                            <div class="recommend-user-name">${user.user_name}</div>
                            <div class="recommend-user-stats">
                                粉丝：${user.follower_count} | 博客：${user.blog_count}
                            </div>
                        </div>
                        <button class="recommend-follow-btn" onclick="followUser(${user.user_id}, this)">关注</button>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '<div style="color:#e74c3c;text-align:center;padding:10px;">加载失败</div>';
            }
        }

        // 关注用户
        async function followUser(userId, btn) {
            if (btn) {
                btn.disabled = true;
                btn.textContent = '关注中...';
            }
            try {
                const res = await fetch('/petblog/api/follows/toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ followee_id: userId })
                });
                const result = await res.json();
                if (result.success && result.followed) {
                    if (btn) {
                        btn.textContent = '已关注';
                        btn.classList.add('followed');
                        btn.style.background = '#27ae60';
                        btn.disabled = false;
                    }
                    // 刷新相关区块
                    if (typeof showFollowers === 'function') showFollowers();
                    if (typeof showFollowing === 'function') showFollowing();
                    if (typeof loadRecommendFollows === 'function') loadRecommendFollows();
                } else if (result.success) {
                    if (btn) {
                        btn.textContent = '关注';
                        btn.classList.remove('followed');
                        btn.style.background = '#3498db';
                        btn.disabled = false;
                    }
                    if (typeof showFollowers === 'function') showFollowers();
                    if (typeof showFollowing === 'function') showFollowing();
                    if (typeof loadRecommendFollows === 'function') loadRecommendFollows();
                } else {
                    if (btn) {
                        btn.textContent = '关注';
                        btn.disabled = false;
                    }
                    alert(result.message || '关注失败');
                }
            } catch (e) {
                if (btn) {
                    btn.textContent = '关注';
                    btn.disabled = false;
                }
                alert('网络错误');
            }
        }

        // 页面加载时自动加载推荐关注
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadRecommendFollows);
        } else {
            loadRecommendFollows();
        }
    </script>
    <script>
        // 退出登录
        function logout() {
            if (confirm('确定要退出登录吗？')) {
                sessionStorage.removeItem('currentUser');
                sessionStorage.removeItem('currentAuditor');
                window.location.href = '/petblog/login.html';
            }
        }
    </script>
</body>
</html>
